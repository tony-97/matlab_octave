<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <title>Presion Admisible</title>
  </head>
  <body>
    <div class="container-fluid m-5">
      <h2>Presion Admisible</h2>
      <div class="row">
        <div class="col-4">
          <form id="valores">
            <div class="form-group">
              <label for="p1">p1</label>
              <input type="number" class="form-control" id="p1" value="1" />
            </div>
            <div class="form-group">
              <label for="p2">p2</label>
              <input type="number" class="form-control" id="p2" value="2" />
            </div>
            <div class="form-group">
              <label for="p3">p3</label>
              <input type="number" class="form-control" id="p3" value="3" />
            </div>
            <div class="form-group">
              <label for="p4">p4</label>
              <input type="number" class="form-control" id="p4" value="4" />
            </div>
            <div class="form-group">
              <label for="p5">p5</label>
              <input type="number" class="form-control" id="p5" value="5" />
            </div>
            <div class="form-group">
              <label for="va1">va1</label>
              <input type="number" class="form-control" id="va1" value="10" />
            </div>
            <div class="form-group">
              <label for="va2">va2</label>
              <input type="number" class="form-control" id="va2" value="15" />
            </div>
            <div class="form-group">
              <label for="va3">va3</label>
              <input type="number" class="form-control" id="va3" value="20" />
            </div>
            <div class="form-group">
              <label for="va4">va4</label>
              <input type="number" class="form-control" id="va4" value="25" />
            </div>
            <div class="form-group">
              <label for="va5">va5</label>
              <input type="number" class="form-control" id="va5" value="30" />
            </div>
            <div class="form-group">
              <label for="va6">va6</label>
              <input type="number" class="form-control" id="va6" value="35" />
            </div>
            <div class="form-group">
              <label for="va7">va7</label>
              <input type="number" class="form-control" id="va7" value="40" />
            </div>
            <div class="form-group">
              <label for="va8">va8</label>
              <input type="number" class="form-control" id="va8" value="45" />
            </div>
            <div class="form-group">
              <label for="va9">va9</label>
              <input type="number" class="form-control" id="va9" value="50" />
            </div>
            <div class="form-group">
              <label for="va10">va10</label>
              <input type="number" class="form-control" id="va10" value="55" />
            </div>
            <div class="form-group">
              <label for="va11">va11</label>
              <input type="number" class="form-control" id="va11" value="60" />
            </div>
            <div class="form-group">
              <label for="va12">va12</label>
              <input type="number" class="form-control" id="va12" value="65" />
            </div>
            <div class="form-group">
              <label for="va13">va13</label>
              <input type="number" class="form-control" id="va13" value="70" />
            </div>
            <div class="form-group">
              <label for="va14">va14</label>
              <input type="number" class="form-control" id="va14" value="75" />
            </div>
            <div class="form-group">
              <label for="va15">va15</label>
              <input type="number" class="form-control" id="va15" value="80" />
            </div>
            <div class="form-group">
              <label for="A">A</label>
              <input type="number" class="form-control" id="A" value="100" />
            </div>
            <div class="form-group">
              <label for="Ixx">Ixx</label>
              <input type="number" class="form-control" id="Ixx" value="2000" />
            </div>
            <div class="form-group">
              <label for="Iyy">Iyy</label>
              <input type="number" class="form-control" id="Iyy" value="3000" />
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
        </div>
        <div id="target" class="col-6"></div>
      </div>
    </div>
  </body>
  <script
    src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"
  ></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
  <script type="text/javascript">
    document.pyodideMplTarget = document.getElementById("target");
    async function main(elems) {
      let pyodide = await loadPyodide();
      await pyodide.loadPackage("numpy");
      await pyodide.loadPackage("matplotlib");
      await pyodide.loadPackage("shapely");
      console.log(
        pyodide.runPython(`
          import sys
          sys.version
      `)
      );
      pyodide.runPython(`
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.patches import Polygon

# Matriz de carga sismica
SISMO = np.array([
    [11, 0.2262, 0.3598, 0.8705],
    [14, 0.1165, 0.2561, 0.8809],
    [17, 0.2262, 0.3598, 0.8705],
    [20, 0.1165, 0.2561, 0.8809]
])

# Matriz de carga muerta mas carga viva
PDPL = np.array([
    [11, 6.3254, 0.0926, 1.583],
    [14, 6.7403, -0.1768, 1.5337],
    [17, 6.3254, 0.0926, -1.583],
    [20, 6.7403, -0.1768, -1.5337]
])

# Matriz de posiciones
a = np.array([
    [11, 0.4, 0.4],
    [14, 0.4, 4.15],
    [17, 6, 0.4],
    [20, 6, 4.15]
])

# Codigo para el calculo de combinaciones de carga
Co = np.zeros((5, 3 * len(a)))

for PO in range(len(a)):
    # CARGAS sismicas
    PS, MXS, MYS = SISMO[PO, 1:]
    # cargas muertas
    Pm, MXm, MYm = PDPL[PO, 1:]
    # cargas vivas
    Pv, MXv, MYv = 0, 0, 0
    P = Pm + Pv
    MX = MXm + MXv
    MY = MYv + MYm
    # Combinacion de cargas
    Co[:, 0 + 3 * PO] = [P, P + PS, P + PS, P + PS, P + PS]
    Co[:, 1 + 3 * PO] = [MX, MX + MXS, MX - MXS, MX, MX]
    Co[:, 2 + 3 * PO] = [MY, MY, MY, MY + MYS, MY - MYS]

# Codigo para calcular el tamaño de la zapata
DIM = np.zeros((len(a), 3))

plt.figure()
for PO in range(len(a)):
    presion = 20  # presion admisible del suelo en tn/m2
    Bx = 1  # minima dimension de la zapata
    Ly = 1  # minima dimension de la zapata

    for i in range(5):
        vmin = -1
        vmax = np.inf
        for zz in np.arange(0, 3.1, 0.1):
            if vmin < 0 or vmax > presion:
                Bx += zz
                Ly += zz
                # PROPIEDADES
                A = Bx * Ly
                Ixx = Bx * Ly**3 / 12
                Iyy = Ly * Bx**3 / 12
                # VERTICES DEL POLIGONO
                xv = np.array([-Bx/2, Bx/2, Bx/2, -Bx/2])
                yv = np.array([Ly/2, Ly/2, -Ly/2, -Ly/2])
                # IDENTIFICAR LOS PUNTOS QUE CAEN DENTRO DEL POLIGONO
                ja = max(Bx, Ly) / 2
                x = np.arange(-ja, ja + 0.1, 0.1)
                y = x
                X, Y = np.meshgrid(x, y)
                xq = X.flatten()
                yq = Y.flatten()
                in_poly = np.array([Polygon(np.column_stack((xv, yv))).contains_point((xi, yi)) for xi, yi in zip(xq, yq)])
                XL = xq[in_poly]
                YL = yq[in_poly]
                ZL = np.zeros((len(XL), 5))

                P = Co[i, 0 + 3 * PO]
                M2 = Co[i, 1 + 3 * PO]
                M3 = Co[i, 2 + 3 * PO]
                k = P / A + M2 * XL / Iyy + M3 * YL / Ixx
                ZL[:, i] = k
                vmin = k.min()
                vmax = k.max()

    DIM[PO, 1] = Bx
    DIM[PO, 2] = Ly

    x = [a[PO, 1] - Bx/2, a[PO, 1] + Bx/2, a[PO, 1] + Bx/2, a[PO, 1] - Bx/2, a[PO, 1] - Bx/2]
    y = [a[PO, 2] + Ly/2, a[PO, 2] + Ly/2, a[PO, 2] - Ly/2, a[PO, 2] - Ly/2, a[PO, 2] + Ly/2]
    plt.plot(a[:, 1], a[:, 2], 's')
    plt.plot(x, y)
    plt.axis([-5, 40, -5, 100])  # using 100 as a large number instead of np.inf
    plt.text(a[PO, 1], a[PO, 2], f'  {Bx:.1f}x{Ly:.1f}m')
    plt.hold(True)

ZL = np.zeros((1681, 5 * len(a)))  # ESTE ES EL PROBLEMA DE DIMENSIONAR

for klk in range(1, 6):
    plt.figure()
    for PO in range(len(a)):
        Bx = DIM[PO, 1]
        Ly = DIM[PO, 2]
        # PROPIEDADES
        A = Bx * Ly
        Ixx = Bx * Ly**3 / 12
        Iyy = Ly * Bx**3 / 12
        # VERTICES DEL POLIGONO
        xv = np.array([-Bx/2, Bx/2, Bx/2, -Bx/2])
        yv = np.array([Ly/2, Ly/2, -Ly/2, -Ly/2])
        # IDENTIFICAR LOS PUNTOS QUE CAEN DENTRO DEL POLIGONO
        ja = max(Bx, Ly) / 2
        JJJ = ja / 20
        x = np.arange(-ja, ja + JJJ, JJJ)
        y = x
        X, Y = np.meshgrid(x, y)
        xq = X.flatten()
        yq = Y.flatten()
        in_poly = np.array([Polygon(np.column_stack((xv, yv))).contains_point((xi, yi)) for xi, yi in zip(xq, yq)])
        XL = xq[in_poly]
        YL = yq[in_poly]

        P = Co[klk - 1, 0 + 3 * PO]
        M2 = Co[klk - 1, 1 + 3 * PO]
        M3 = Co[klk - 1, 2 + 3 * PO]
        k = P / A + M2 * XL / Iyy + M3 * YL / Ixx
        ZL[:, PO + len(a) * (klk - 1)] = k
        vmin = k.min()
        vmax = k.max()

        # PLOT
        plt.plot(xv + a[PO, 1], yv + a[PO, 2], 'k-', linewidth=1)
        plt.scatter(XL + a[PO, 1], YL + a[PO, 2], c=ZL[:, PO + len(a) * (klk - 1)], marker='.')
        plt.colorbar(label='Presion Admisible (Tn/m)')
        plt.view(0, 90)
        plt.axis([-5, 100, -5, 100])  # using 100 as a large number instead of np.inf
        plt.title(f'Comb {klk}\nσ_min = {vmin:.2f} Tn/m\nσ_max = {vmax:.2f} Tn/m')
        plt.hold(True)

plt.show()
        `);
    }
    document
      .getElementById("valores")
      .addEventListener("submit", async (event) => {
        event.preventDefault();
        main(event.target.elements);
        return false;
      });
  </script>
</html>
